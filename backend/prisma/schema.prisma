generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Org {
  /// org_id used in protocol, e.g. "test_org"
  id        String   @id
  name      String
  slug      String   @unique

  /// Logical status; enforced in code (e.g. "active", "suspended").
  status    String   @default("active")

  /// Org-level configuration blob (allowed protocol versions, clock skew, etc.).
  config    Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  receivers Receiver[]
  apiKeys   ApiKey[]
  events    PresenceEvent[]
}

model Receiver {
  /// receiver_id from spec, e.g. "R1"
  id    String @id
  orgId String
  org   Org    @relation(fields: [orgId], references: [id])

  displayName   String
  locationLabel String?
  latitude      Float?
  longitude     Float?

  /// "hmac_shared_secret" | "public_key" | "none_low_trust"
  authMode         String
  /// Argon2/bcrypt hash, required when authMode = hmac_shared_secret.
  sharedSecretHash String?
  /// PEM when using signature-based auth.
  publicKeyPem     String?

  firmwareVersion String?
  /// Logical status; enforced in code (e.g. "active", "disabled").
  status          String   @default("active")
  lastSeenAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events PresenceEvent[]

  @@index([orgId])
}

model ApiKey {
  id    String @id @default(cuid())
  orgId String
  org   Org    @relation(fields: [orgId], references: [id])

  name      String
  /// First 6â€“8 chars for identification.
  keyPrefix String @unique
  /// Argon2/bcrypt hash of full key.
  keyHash   String
  /// Simple comma-separated string or JSON; interpreted in code.
  scopes    String

  createdAt  DateTime @default(now())
  lastUsedAt DateTime?
  revokedAt  DateTime?

  @@index([orgId])
  @@index([keyPrefix])
}

model PresenceEvent {
  id String @id @default(cuid())

  orgId      String
  receiverId String

  org      Org      @relation(fields: [orgId], references: [id])
  receiver Receiver @relation(fields: [receiverId], references: [id])

  /// Identity / linking (can be null for anonymous mode).
  /// Hashed device_id or derived identifier per spec v2.
  deviceIdHash String?
  /// Optional external reference (student/employee ID, if used).
  userRef      String?

  /// Time fields.
  /// Client timestamp from packet, in milliseconds.
  clientTimestampMs BigInt
  /// When backend processed the report.
  serverTimestamp   DateTime @default(now())

  /// Normalized slot index per spec.
  timeSlot Int
  /// Protocol version from packet.
  version  Int
  /// Bitmask flags field from packet.
  flags    Int

  /// Token + security.
  /// Short prefix sent over the air.
  tokenPrefix  String
  /// Hash of full token for replay detection (no raw token storage).
  tokenHash    String
  /// MAC if HMAC auth is used.
  macHex       String?
  /// Signature if public-key auth is used.
  signatureHex String?

  /// True if processed as low-trust anonymous presence per spec v2.
  isAnonymous Boolean

  /// e.g. "accepted", "rejected_mac", "rejected_signature",
  /// "rejected_window", "ignored_duplicate".
  authResult String
  /// Human-readable debug reason.
  reason     String?

  /// Optional context: RSSI, receiver IP, user-agent, etc.
  meta Json?

  createdAt DateTime @default(now())

  @@index([orgId, serverTimestamp])
  @@index([orgId, receiverId, serverTimestamp])
  @@index([orgId, deviceIdHash])
  @@index([orgId, tokenHash])
}
