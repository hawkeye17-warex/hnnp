generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Org {
  /// org_id used in protocol, e.g. "test_org"
  id   String @id
  name String
  slug String @unique

  /// Logical status; enforced in code (e.g. "active", "suspended").
  status String @default("active")

  /// Org-level configuration blob (allowed protocol versions, clock skew, etc.).
  config Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  receivers    Receiver[]
  apiKeys      ApiKey[]
  events       PresenceEvent[]
  devices      Device[]
  links        Link[]
  sessions     PresenceSession[]
  userProfiles UserProfile[]
  quizSessions QuizSession[]
  shifts       Shift[]
  adminUsers   AdminUser[]
  auditLogs    AuditLog[]
}

model Receiver {
  /// receiver_id from spec, e.g. "R1"
  id    String @id
  orgId String
  org   Org    @relation(fields: [orgId], references: [id])

  displayName   String
  locationLabel String?
  latitude      Float?
  longitude     Float?

  /// "hmac_shared_secret" | "public_key" | "none_low_trust"
  authMode         String
  /// Argon2/bcrypt hash, required when authMode = hmac_shared_secret.
  sharedSecretHash String?
  /// PEM when using signature-based auth.
  publicKeyPem     String?

  firmwareVersion String?
  /// Logical status; enforced in code (e.g. "active", "disabled").
  status          String    @default("active")
  lastSeenAt      DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  events       PresenceEvent[]
  sessions     PresenceSession[]
  quizSessions QuizSession[]

  @@index([orgId])
}

model ApiKey {
  id    String @id @default(cuid())
  orgId String
  org   Org    @relation(fields: [orgId], references: [id])

  name      String
  /// First 6â€“8 chars for identification.
  keyPrefix String @unique
  /// Argon2/bcrypt hash of full key.
  keyHash   String
  /// Simple comma-separated string or JSON; interpreted in code.
  scopes    String

  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?
  revokedAt  DateTime?

  @@index([orgId])
  @@index([keyPrefix])
}

model PresenceEvent {
  id String @id @default(cuid())

  orgId      String
  receiverId String

  org      Org      @relation(fields: [orgId], references: [id])
  receiver Receiver @relation(fields: [receiverId], references: [id])

  /// Identity / linking (can be null for anonymous mode).
  /// Hashed device_id or derived identifier per spec v2.
  deviceIdHash String?
  /// Optional external reference (student/employee ID, if used).
  userRef      String?

  /// Time fields.
  /// Client timestamp from packet, in milliseconds.
  clientTimestampMs BigInt
  /// When backend processed the report.
  serverTimestamp   DateTime @default(now())

  /// Normalized slot index per spec.
  timeSlot Int
  /// Protocol version from packet.
  version  Int
  /// Bitmask flags field from packet.
  flags    Int

  /// Token + security.
  /// Short prefix sent over the air.
  tokenPrefix  String
  /// Hash of full token for replay detection (no raw token storage).
  tokenHash    String
  /// MAC if HMAC auth is used.
  macHex       String?
  /// Signature if public-key auth is used.
  signatureHex String?

  /// True if processed as low-trust anonymous presence per spec v2.
  isAnonymous Boolean

  /// e.g. "accepted", "rejected_mac", "rejected_signature",
  /// "rejected_window", "ignored_duplicate".
  authResult String
  /// Human-readable debug reason.
  reason     String?

  /// Optional context: RSSI, receiver IP, user-agent, etc.
  meta Json?

  createdAt DateTime @default(now())

  @@index([orgId, serverTimestamp])
  @@index([orgId, receiverId, serverTimestamp])
  @@index([orgId, deviceIdHash])
  @@index([orgId, tokenHash])
}

model Device {
  id          String   @id @default(cuid())
  orgId       String
  org         Org      @relation(fields: [orgId], references: [id])
  displayName String?
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  keys  DeviceKey[]
  links Link[]

  @@index([orgId])
}

model DeviceKey {
  id         String    @id
  deviceId   String
  device     Device    @relation(fields: [deviceId], references: [id])
  keyHash    String
  algorithm  String
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?

  @@index([deviceId])
}

model Link {
  id          String    @id
  orgId       String
  deviceId    String?
  userRef     String?
  status      String
  createdAt   DateTime  @default(now())
  activatedAt DateTime?
  revokedAt   DateTime?

  org    Org     @relation(fields: [orgId], references: [id])
  device Device? @relation(fields: [deviceId], references: [id])

  @@index([orgId])
  @@index([orgId, userRef])
  @@index([orgId, deviceId])
}

model PresenceSession {
  id           String    @id
  orgId        String
  receiverId   String
  userRef      String?
  deviceIdHash String?
  startedAt    DateTime
  endedAt      DateTime?
  flags        Int
  meta         Json?

  org      Org      @relation(fields: [orgId], references: [id])
  receiver Receiver @relation(fields: [receiverId], references: [id])

  @@index([orgId])
  @@index([orgId, userRef])
  @@index([orgId, deviceIdHash])
  @@index([orgId, startedAt])
}

model AdminUser {
  id        String   @id @default(cuid())
  orgId     String
  org       Org      @relation(fields: [orgId], references: [id])
  email     String   @unique
  name      String?
  role      String   @default("admin")
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orgId])
}

model AuditLog {
  id         String   @id @default(cuid())
  orgId      String?
  org        Org?     @relation(fields: [orgId], references: [id])
  actorKey   String?
  actorRole  String?
  action     String
  entityType String?
  entityId   String?
  details    Json?
  createdAt  DateTime @default(now())

  @@index([orgId, createdAt])
  @@index([entityType, entityId])
}

model UserProfile {
  id           String   @id @default(cuid())
  userId       String
  orgId        String
  type         String
  capabilities Json?
  createdAt    DateTime @default(now())

  org         Org              @relation(fields: [orgId], references: [id])
  submissions QuizSubmission[]
  shifts      Shift[]

  @@index([userId])
  @@index([orgId])
}

model QuizSession {
  id           String   @id @default(cuid())
  orgId        String
  courseId     String?
  receiverId   String?
  title        String
  startTime    DateTime
  endTime      DateTime
  status       String
  createdBy    String
  settingsJson Json?
  testMode     Boolean  @default(false)
  createdAt    DateTime @default(now())

  org         Org              @relation(fields: [orgId], references: [id])
  receiver    Receiver?        @relation(fields: [receiverId], references: [id])
  questions   QuizQuestion[]
  submissions QuizSubmission[]

  @@index([orgId])
  @@index([receiverId])
  @@index([createdBy])
}

model QuizQuestion {
  id            String   @id @default(cuid())
  quizId        String
  type          String
  text          String
  optionsJson   Json?
  correctOption String?
  timeLimitSec  Int?
  createdAt     DateTime @default(now())

  quiz QuizSession @relation(fields: [quizId], references: [id])

  @@index([quizId])
}

model QuizSubmission {
  id          String   @id @default(cuid())
  quizId      String
  profileId   String
  submittedAt DateTime
  answersJson Json?
  score       Float?
  status      String
  createdAt   DateTime @default(now())

  quiz    QuizSession @relation(fields: [quizId], references: [id])
  profile UserProfile @relation(fields: [profileId], references: [id])

  @@index([quizId])
  @@index([profileId])
}

model Shift {
  id           String    @id @default(cuid())
  profileId    String
  orgId        String
  locationId   String?
  startTime    DateTime
  endTime      DateTime?
  totalSeconds Int?
  createdBy    String?
  closedBy     String?
  status       String
  createdAt    DateTime  @default(now())
  editedBy     String?
  editedAt     DateTime?

  org     Org         @relation(fields: [orgId], references: [id])
  profile UserProfile @relation(fields: [profileId], references: [id])
  breaks  Break[]

  @@index([profileId])
  @@index([orgId])
}

model Break {
  id           String    @id @default(cuid())
  shiftId      String
  startTime    DateTime
  endTime      DateTime?
  totalSeconds Int?
  type         String?
  createdAt    DateTime  @default(now())
  editedBy     String?
  editedAt     DateTime?

  shift Shift @relation(fields: [shiftId], references: [id])

  @@index([shiftId])
}
