generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Org {
  /// org_id used in protocol, e.g. "test_org"
  id             String            @id
  name           String
  slug           String            @unique
  /// Logical status; enforced in code (e.g. "active", "suspended").
  status         String            @default("active")
  /// Org-level configuration blob (allowed protocol versions, clock skew, etc.).
  config         Json?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  /// Vertical / industry for this org.
  /// Allowed values: "school", "factory", "office", "hospital", "gov", "other"
  orgType        String            @default("office")
  /// Enabled modules/features for this org.
  /// Allowed values include:
  /// "attendance", "quizzes", "exams", "sessions", "shifts", "workzones", "safety", "access_control", "analytics", "hps_insights", "developer_api"
  enabledModules String[]          @default([])
  adminUsers     AdminUser[]
  apiKeys        ApiKey[]
  auditLogs      AuditLog[]
  auditEvents    AuditEvent[]
  devices        Device[]
  links          Link[]
  orgRoles       OrgRole[]
  hpsPolicy      HpsPolicy?
  events         PresenceEvent[]
  sessions       PresenceSession[]
  quizSessions   QuizSession[]
  receivers      Receiver[]
  shifts         Shift[]
  userProfiles   UserProfile[]
  loaProfiles    LoaProfile[]
  loaAssignments LoaAssignment[]
}

/// Per-user role assignments within an org.
model OrgRole {
  id        String   @id @default(cuid())
  orgId     String
  userId    String
  /// Allowed: owner | admin | viewer | hr | security
  role      String
  createdAt DateTime @default(now())
  org       Org      @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@index([userId])
}

model Receiver {
  /// receiver_id from spec, e.g. "R1"
  id               String            @id
  orgId            String
  displayName      String
  locationLabel    String?
  latitude         Float?
  longitude        Float?
  /// "hmac_shared_secret" | "public_key" | "none_low_trust"
  authMode         String
  /// Argon2/bcrypt hash, required when authMode = hmac_shared_secret.
  sharedSecretHash String?
  /// PEM when using signature-based auth.
  publicKeyPem     String?
  firmwareVersion  String?
  /// Logical status; enforced in code (e.g. "active", "disabled").
  status           String            @default("active")
  lastSeenAt       DateTime?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  events           PresenceEvent[]
  sessions         PresenceSession[]
  quizSessions     QuizSession[]
  org              Org               @relation(fields: [orgId], references: [id])

  @@index([orgId])
}

model ApiKey {
  id         String    @id @default(cuid())
  orgId      String
  name       String
  /// First 6â€“8 chars for identification.
  keyPrefix  String    @unique
  /// Argon2/bcrypt hash of full key.
  keyHash    String
  /// Simple comma-separated string or JSON; interpreted in code.
  scopes     String
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?
  revokedAt  DateTime?
  org        Org       @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@index([keyPrefix])
}

model PresenceEvent {
  id                String   @id @default(cuid())
  orgId             String
  receiverId        String
  /// Normalized slot index per spec.
  timeSlot          Int
  /// e.g. "accepted", "rejected_mac", "rejected_signature",
  /// "rejected_window", "ignored_duplicate".
  authResult        String
  /// Time fields.
  /// Client timestamp from packet, in milliseconds.
  clientTimestampMs BigInt
  createdAt         DateTime @default(now())
  /// Identity / linking (can be null for anonymous mode).
  /// Hashed device_id or derived identifier per spec v2.
  deviceIdHash      String?
  /// Bitmask flags field from packet.
  flags             Int
  /// True if processed as low-trust anonymous presence per spec v2.
  isAnonymous       Boolean
  /// MAC if HMAC auth is used.
  macHex            String?
  /// Optional context: RSSI, receiver IP, user-agent, etc.
  meta              Json?
  /// Human-readable debug reason.
  reason            String?
  /// When backend processed the report.
  serverTimestamp   DateTime @default(now())
  /// Signature if public-key auth is used.
  signatureHex      String?
  /// Hash of full token for replay detection (no raw token storage).
  tokenHash         String
  /// Token + security.
  /// Short prefix sent over the air.
  tokenPrefix       String
  /// Optional external reference (student/employee ID, if used).
  userRef           String?
  /// Protocol version from packet.
  version           Int
  org               Org      @relation(fields: [orgId], references: [id])
  receiver          Receiver @relation(fields: [receiverId], references: [id])

  @@index([orgId, serverTimestamp])
  @@index([orgId, receiverId, serverTimestamp])
  @@index([orgId, deviceIdHash])
  @@index([orgId, tokenHash])
}

model Device {
  id          String      @id @default(cuid())
  orgId       String
  displayName String?
  status      String      @default("active")
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  org         Org         @relation(fields: [orgId], references: [id])
  keys        DeviceKey[]
  links       Link[]

  @@index([orgId])
}

model DeviceKey {
  id         String    @id
  deviceId   String
  keyHash    String
  algorithm  String
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?
  device     Device    @relation(fields: [deviceId], references: [id])

  @@index([deviceId])
}

model Link {
  id          String    @id
  orgId       String
  deviceId    String?
  userRef     String?
  status      String
  createdAt   DateTime  @default(now())
  activatedAt DateTime?
  revokedAt   DateTime?
  device      Device?   @relation(fields: [deviceId], references: [id])
  org         Org       @relation(fields: [orgId], references: [id])

  @@index([orgId])
  @@index([orgId, userRef])
  @@index([orgId, deviceId])
}

model PresenceSession {
  id           String    @id
  orgId        String
  receiverId   String
  userRef      String?
  deviceIdHash String?
  startedAt    DateTime
  endedAt      DateTime?
  flags        Int
  meta         Json?
  org          Org       @relation(fields: [orgId], references: [id])
  receiver     Receiver  @relation(fields: [receiverId], references: [id])

  @@index([orgId])
  @@index([orgId, userRef])
  @@index([orgId, deviceIdHash])
  @@index([orgId, startedAt])
}

model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  role      String   @default("admin")
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  orgId     String
  org       Org      @relation(fields: [orgId], references: [id])

  @@index([orgId])
}

model AuditLog {
  id         String   @id @default(cuid())
  orgId      String?
  actorKey   String?
  actorRole  String?
  action     String
  entityType String?
  entityId   String?
  details    Json?
  createdAt  DateTime @default(now())
  org        Org?     @relation(fields: [orgId], references: [id])

  @@index([orgId, createdAt])
  @@index([entityType, entityId])
}

model UserProfile {
  id           String           @id @default(cuid())
  type         String
  capabilities Json?
  createdAt    DateTime         @default(now())
  orgId        String
  userId       String
  submissions  QuizSubmission[]
  shifts       Shift[]
  org          Org              @relation(fields: [orgId], references: [id])

  @@index([userId])
  @@index([orgId])
}

model QuizSession {
  id           String           @id @default(cuid())
  title        String
  status       String
  courseId     String?
  createdAt    DateTime         @default(now())
  createdBy    String
  endTime      DateTime
  orgId        String
  receiverId   String?
  settingsJson Json?
  startTime    DateTime
  testMode     Boolean          @default(false)
  questions    QuizQuestion[]
  org          Org              @relation(fields: [orgId], references: [id])
  receiver     Receiver?        @relation(fields: [receiverId], references: [id])
  submissions  QuizSubmission[]

  @@index([orgId])
  @@index([receiverId])
  @@index([createdBy])
}

model QuizQuestion {
  id            String      @id @default(cuid())
  type          String
  text          String
  correctOption String?
  createdAt     DateTime    @default(now())
  optionsJson   Json?
  quizId        String
  timeLimitSec  Int?
  quiz          QuizSession @relation(fields: [quizId], references: [id])

  @@index([quizId])
}

model QuizSubmission {
  id          String      @id @default(cuid())
  score       Float?
  status      String
  answersJson Json?
  createdAt   DateTime    @default(now())
  profileId   String
  quizId      String
  submittedAt DateTime
  profile     UserProfile @relation(fields: [profileId], references: [id])
  quiz        QuizSession @relation(fields: [quizId], references: [id])

  @@index([quizId])
  @@index([profileId])
}

model Shift {
  id           String      @id @default(cuid())
  profileId    String
  orgId        String
  locationId   String?
  startTime    DateTime
  endTime      DateTime?
  totalSeconds Int?
  createdBy    String?
  closedBy     String?
  status       String
  createdAt    DateTime    @default(now())
  editedAt     DateTime?
  editedBy     String?
  breaks       Break[]
  org          Org         @relation(fields: [orgId], references: [id])
  profile      UserProfile @relation(fields: [profileId], references: [id])

  @@index([profileId])
  @@index([orgId])
}

model Break {
  id           String    @id @default(cuid())
  shiftId      String
  startTime    DateTime
  endTime      DateTime?
  totalSeconds Int?
  type         String?
  createdAt    DateTime  @default(now())
  editedAt     DateTime?
  editedBy     String?
  shift        Shift     @relation(fields: [shiftId], references: [id])

  @@index([shiftId])
}

model AuditEvent {
  id         String   @id @default(cuid())
  orgId      String
  userId     String?
  action     String
  entityType String?
  entityId   String?
  metadata   Json?
  createdAt  DateTime @default(now())

  org Org @relation(fields: [orgId], references: [id])

  @@index([orgId, createdAt])
  @@index([orgId, action])
  @@index([orgId, userId])
}

/// Level of Assurance profiles for Presence Passport.
model LoaProfile {
  id          String   @id @default(cuid())
  orgId       String
  name        String
  requirements Json?
  createdAt   DateTime @default(now())

  org        Org             @relation(fields: [orgId], references: [id])
  assignments LoaAssignment[]

  @@index([orgId])
}

model LoaAssignment {
  id           String   @id @default(cuid())
  orgId        String
  useCase      String
  loaProfileId String
  createdAt    DateTime @default(now())

  org        Org        @relation(fields: [orgId], references: [id])
  loaProfile LoaProfile @relation(fields: [loaProfileId], references: [id])

  @@index([orgId, useCase])
}

/// HPS (Presence Assurance) policy per org.
model HpsPolicy {
  id                       String   @id @default(cuid())
  orgId                    String
  minScore                 Float    @default(0.7)
  allowFallbackGesture     Boolean  @default(true)
  requireHpsForAttendance  Boolean  @default(false)
  requireHpsForAccess      Boolean  @default(false)
  updatedBy                String?
  updatedAt                DateTime @default(now())

  org Org @relation(fields: [orgId], references: [id])

  @@unique([orgId])
  @@index([orgId])
}
